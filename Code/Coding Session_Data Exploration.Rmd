---
title: "Coding Session: Data Wrangling 1"
author: "Environmental Data Analytics | Rachel Gonsenhauser"
date: "Spring 2020"
output: pdf_document
geometry: margin=2.54cm
---

##Setup 

```{r setup, include=FALSE}
# Setting up session
setwd("/Users/rachelgonsenhauser/Documents/Final_Project_Environmental_Data_Analytics")
getwd()
library(dplyr)
library(tidyverse)
library(lubridate)

# Pulling in processed dataset
Water.Quality.And.Income.Processed <- read.csv("../Data/Processed/CDC_WaterQualityAndincome_Processed.csv")
```

## Preliminary data exploration of processed dataset

```{r}

# Data exploration of processed dataset
colnames(Water.Quality.And.Income.Processed)
dim(Water.Quality.And.Income.Processed)
str(Water.Quality.And.Income.Processed)

class(Water.Quality.And.Income.Processed$Year)
class(Water.Quality.And.Income.Processed$State)
class(Water.Quality.And.Income.Processed$PWS.ID)
class(Water.Quality.And.Income.Processed$stateFIPS)
class(Water.Quality.And.Income.Processed$countyFIPS)
class(Water.Quality.And.Income.Processed$County)
class(Water.Quality.And.Income.Processed$PWS.ID)
class(Water.Quality.And.Income.Processed$CWS.Name)
class(Water.Quality.And.Income.Processed$Population.Served)
class(Water.Quality.And.Income.Processed$MHI)
class(Water.Quality.And.Income.Processed$Arsenic_ugL)
class(Water.Quality.And.Income.Processed$PFAS_ppt)
class(Water.Quality.And.Income.Processed$TTHM_ugL)
class(Water.Quality.And.Income.Processed$Uranium_ugL)
class(Water.Quality.And.Income.Processed$MCL_Arsenic)
class(Water.Quality.And.Income.Processed$MCL_TTHM)
class(Water.Quality.And.Income.Processed$MCL_Uranium)

# Changing FIPs codes to factor variables 
class(Water.Quality.And.Income.Processed$countyFIPS)
Water.Quality.And.Income.Processed$countyFIPS <- as.factor(Water.Quality.And.Income.Processed$countyFIPS)
class(Water.Quality.And.Income.Processed$countyFIPS)

class(Water.Quality.And.Income.Processed$stateFIPS)
Water.Quality.And.Income.Processed$stateFIPS <- as.factor(Water.Quality.And.Income.Processed$stateFIPS)
class(Water.Quality.And.Income.Processed$stateFIPS)

# Changing contaminant and MHI variables to numeric variables
Water.Quality.And.Income.Processed$MHI <-
  str_replace(Water.Quality.And.Income.Processed$MHI,
              pattern = "([,])", replacement = "")
class(Water.Quality.And.Income.Processed$MHI)
Water.Quality.And.Income.Processed$MHI <- as.numeric(Water.Quality.And.Income.Processed$MHI)
class(Water.Quality.And.Income.Processed$MHI)

class(Water.Quality.And.Income.Processed$Arsenic_ugL)
Water.Quality.And.Income.Processed$Arsenic_ugL <- as.numeric(Water.Quality.And.Income.Processed$Arsenic_ugL)
class(Water.Quality.And.Income.Processed$Arsenic_ugL)

class(Water.Quality.And.Income.Processed$PFAS_ppt)
Water.Quality.And.Income.Processed$PFAS_ppt <- as.numeric(Water.Quality.And.Income.Processed$PFAS_ppt)
class(Water.Quality.And.Income.Processed$PFAS_ppt)

class(Water.Quality.And.Income.Processed$TTHM_ugL)
Water.Quality.And.Income.Processed$TTHM_ugL <- as.numeric(Water.Quality.And.Income.Processed$TTHM_ugL)
class(Water.Quality.And.Income.Processed$TTHM_ugL)

class(Water.Quality.And.Income.Processed$Uranium_ugL)
Water.Quality.And.Income.Processed$Uranium_ugL <- as.numeric(Water.Quality.And.Income.Processed$Uranium_ugL)
class(Water.Quality.And.Income.Processed$Uranium_ugL)
```

## Some visualizations to explore distribution of variables 

```{r}
# Exploring data distributions 
mean(Water.Quality.And.Income.Processed$Arsenic_ugL)
sd(Water.Quality.And.Income.Processed$Arsenic_ugL)
summary(Water.Quality.And.Income.Processed$Arsenic_ugL)

ggplot(Water.Quality.And.Income.Processed) +
  geom_histogram(aes(x = Arsenic_ugL))

# Arsenic levels seem high, check back to original data - this is correct, checked original data
mean(Water.Quality.And.Income.Processed$MHI)
sd(Water.Quality.And.Income.Processed$MHI)
summary(Water.Quality.And.Income.Processed$MHI)

summary(Water.Quality.And.Income.Processed$Arsenic_ugL)

# Looking at distribution of some continuous variables
 ggplot(Water.Quality.And.Income.Processed, aes(x = MHI)) +
  geom_histogram(binwidth = 10000) + 
  scale_x_continuous(limits = c(0, 100000))
 
 ggplot(Water.Quality.And.Income.Processed, aes(x = Arsenic_ugL)) +
   geom_histogram(binwidth = 100) +
   scale_x_continuous(limits = c(0,3000))

# Looking at distribution of some categorial variables
ggplot(Water.Quality.And.Income.Processed, aes(x = MCL_Arsenic)) +
  geom_bar()

ggplot(Water.Quality.And.Income.Processed, aes(x = MCL_Uranium)) +
  geom_bar()

ggplot(Water.Quality.And.Income.Processed, aes(x = MCL_TTHM)) +
  geom_bar()
# Lots of NAs for TTHM and Uranium MCLs

# Frequency polygons for multiple continuous variables
ggplot(Water.Quality.And.Income.Processed) +
  geom_freqpoly(aes(x = Arsenic_ugL), bins = 50, color = "pink") +
  geom_freqpoly(aes(x = Uranium_ugL), bins = 50, color = "royalblue") +
  geom_freqpoly(aes(x = PFAS_ppt), bins = 50,  lty = 2, color = "orange") +
    geom_freqpoly(aes(x = TTHM_ugL), bins = 50,  lty = 2, color = "green") +
  scale_x_continuous(limits = c(0, 10000)) +
   theme(legend.position = "top")

ggplot(Water.Quality.And.Income.Processed) +
  geom_freqpoly(aes(x = Uranium_ugL, color = State), bins = 50) +
  scale_x_continuous(limits = c(0, 10000)) +
  theme(legend.position = "top")

# Box plots 
ggplot(Water.Quality.And.Income.Processed) +
  geom_boxplot(aes(x = Year, y = Arsenic_ugL))

ggplot(Water.Quality.And.Income.Processed) +
  geom_boxplot(aes(x = Year, y = TTHM_ugL))

# Changing class of Year to factor variable
class(Water.Quality.And.Income.Processed$Year)
Water.Quality.And.Income.Processed$Year <- as.factor(Water.Quality.And.Income.Processed$Year)

# Violin plots
 ggplot(Water.Quality.And.Income.Processed) +
  geom_violin(aes(x = Year, y = Arsenic_ugL), 
              draw_quantiles = c(0.25, 0.5, 0.75),
              scale = "count")
 # Violin plots show similar distribution each year, median around the same place and some large value outliers every year, not much annual variation
 
  ggplot(Water.Quality.And.Income.Processed) +
  geom_violin(aes(x = Year, y = MHI), 
              draw_quantiles = c(0.25, 0.5, 0.75),
              scale = "count")
  #MHI seems to have a slight upward trend over time
 
  Massachusetts.data <- filter(Water.Quality.And.Income.Processed, State == "Massachusetts") 
  
  ggplot(Massachusetts.data) +
  geom_violin(aes(x = Year, y = Arsenic_ugL), 
              draw_quantiles = c(0.25, 0.5, 0.75),
              scale = "count")
 #Interested in looking at arsenic in Massachusetts since lots of arsenic hot spots from underlying geology, not much variation from year to year, 2003 looks interesting though
  
    ggplot(Massachusetts.data) +
  geom_violin(aes(x = MCL_Arsenic, y = Population.Served), 
              draw_quantiles = c(0.25, 0.5, 0.75),
              scale = "count")
  
 # Scatterplots (relationships between continuous variables)
ggplot(Massachusetts.data) +
  geom_point(aes(x = MHI, y = Arsenic_ugL))
             
ggplot(Massachusetts.data) +
  geom_point(aes(x = PFAS_ppt, y = Arsenic_ugL))
             
ggplot(Massachusetts.data) +
  geom_point(aes(x = TTHM_ugL, y = Arsenic_ugL)) 

ggplot(Massachusetts.data) +
  geom_point(aes(x = Arsenic_ugL, y = Uranium_ugL))
```

## Filtering down data to explore PFAS data

```{r}
# Filtering to 2013-2015 to explore PFAS data (data only collected over this period for PFAS)

# drop_na only drops rows where NAs are present in a specified column of data whereas na.exclude and na.omit take away all rows in whole dataset where there is an NA (so using drop_NA here to just only have complete rows to compare)

PFAS.data <- filter(Water.Quality.And.Income.Processed, Year == "2014") %>%
  drop_na()

# Not enough data once dropping NAs to compare PFAS to all other variables in dataset, will explore data to see if enough data to justify comparing to some only some variables for analysis later

PFAS.data2 <- Water.Quality.And.Income.Processed %>%
  filter(Year == "2014") %>%
  select(MHI, PFAS_ppt, PWS.ID, Population.Served) %>%
  drop_na()


# Only 89 complete observations with PFAS, so will do some analyses including and some excluding PFAS data

```



